<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emoji Quit Tracker</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- If you upload icon-180.png to repo root, uncomment this:
  <link rel="apple-touch-icon" href="icon-180.png">
  -->

  <style>
    :root{
      --bg:#f0f9ff;
      --card:#ffffff;
      --line:#e0f2fe;
      --text:#0f172a;
      --muted:#64748b;

      --green:#22c55e;
      --amber:#f59e0b;
      --blue:#3b82f6;
      --purple:#a855f7;
      --red:#ef4444;

      --shadow: 0 1px 6px rgba(15, 23, 42, .10);
      --shadow2: 0 6px 18px rgba(15, 23, 42, .10);
    }

    body{ font-family:-apple-system, system-ui, Arial; margin:0; background:var(--bg); color:var(--text); }

    header{
      padding:14px;
      background:rgba(255,255,255,.9);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:10;
    }

    h1{ font-size:18px; margin:0 0 8px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    button{
      border:none; background:#fff;
      padding:10px 12px; border-radius:14px;
      cursor:pointer; box-shadow: var(--shadow);
      font-size:14px;
    }
    button.primary{
      background:linear-gradient(135deg, var(--blue), var(--purple));
      color:#fff; box-shadow: var(--shadow2);
    }
    button:active{ transform:scale(.98); }

    .pill{
      font-size:12px; padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff; color:var(--muted);
      box-shadow: var(--shadow);
    }

    main{ padding:14px; max-width:1100px; margin:0 auto; }
    .grid{ display:grid; grid-template-columns: 1.25fr 1fr; gap:12px; }
    @media (max-width: 960px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow);
    }
    .card h2{ font-size:15px; margin:0 0 10px; }
    .muted{ color:var(--muted); font-size:12px; line-height:1.35rem; }

    .banner{
      border:1px solid #fde68a;
      background:linear-gradient(180deg, #fff7ed, #fff);
      border-radius:16px;
      padding:10px 12px;
      margin-bottom:10px;
      box-shadow: var(--shadow);
    }

    .calHead{
      display:flex; justify-content:space-between;
      align-items:flex-start; gap:10px; flex-wrap:wrap;
    }
    .monthTitle{ font-weight:900; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    select, input[type="text"], input[type="time"], input[type="number"], textarea{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      font-size:14px;
      box-shadow: var(--shadow);
    }
    textarea{ width:100%; min-height:90px; resize:vertical; }

    .cal{ margin-top:10px; display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
    .dow{ font-size:12px; color:var(--muted); text-align:center; padding:2px 0 6px; }

    .day{
      min-height:62px;
      background:#fff;
      border:1px solid rgba(224,242,254,.9);
      border-radius:14px;
      padding:7px;
      display:flex; flex-direction:column; gap:6px;
      cursor:pointer;
      box-shadow: 0 1px 3px rgba(15,23,42,.08);
    }
    .day.other{ opacity:.45; }
    .day.selected{ outline: 2px solid rgba(59,130,246,.65); }
    .day.has-emoji{
      background: linear-gradient(180deg, #ecfeff, #ffffff);
      border:1px solid rgba(103,232,249,.75);
    }

    .num{ font-size:12px; color:var(--muted); display:flex; justify-content:space-between; align-items:center; }
    .emojis{ display:flex; flex-wrap:wrap; gap:6px; }

    .chip{
      border:none;
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-size:18px;
      cursor:pointer;
      line-height:1;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: var(--shadow);
      transition: transform .05s ease;
    }
    .chip:active{ transform:scale(.97); }
    .chip.on{
      color:#0b1220;
      outline: 2px solid rgba(15,23,42,.08);
      box-shadow: var(--shadow2);
    }
    .label{ font-size:12px; color:rgba(15,23,42,.70); }

    /* Soft colour per emoji (add more if you want) */
    .chip[data-emoji="ğŸ°"]{ background:#fff7ed; } .chip.on[data-emoji="ğŸ°"]{ background:#fed7aa; }
    .chip[data-emoji="ğŸš­"]{ background:#ecfdf5; } .chip.on[data-emoji="ğŸš­"]{ background:#bbf7d0; }
    .chip[data-emoji="ğŸºğŸš«"]{ background:#eff6ff; } .chip.on[data-emoji="ğŸºğŸš«"]{ background:#bfdbfe; }

    /* Exercise emojis (all get a fresh cyan-ish tint) */
    .chip[data-emoji="ğŸ‹ï¸â€â™‚ï¸"], .chip[data-emoji="ğŸƒ"], .chip[data-emoji="ğŸš¶"], .chip[data-emoji="ğŸš´"], .chip[data-emoji="ğŸ§˜"], .chip[data-emoji="ğŸŠ"]{ background:#ecfeff; }
    .chip.on[data-emoji="ğŸ‹ï¸â€â™‚ï¸"], .chip.on[data-emoji="ğŸƒ"], .chip.on[data-emoji="ğŸš¶"], .chip.on[data-emoji="ğŸš´"], .chip.on[data-emoji="ğŸ§˜"], .chip.on[data-emoji="ğŸŠ"]{ background:#a5f3fc; }

    .chip[data-emoji="ğŸ”¥"]{ background:#fff7ed; } .chip.on[data-emoji="ğŸ”¥"]{ background:#ffedd5; }
    .chip[data-emoji="ğŸŒ±"]{ background:#ecfdf5; } .chip.on[data-emoji="ğŸŒ±"]{ background:#d1fae5; }
    .chip[data-emoji="ğŸ˜Œ"]{ background:#eff6ff; } .chip.on[data-emoji="ğŸ˜Œ"]{ background:#dbeafe; }
    .chip[data-emoji="ğŸ§ "]{ background:#f5f3ff; } .chip.on[data-emoji="ğŸ§ "]{ background:#ede9fe; }
    .chip[data-emoji="ğŸ˜®â€ğŸ’¨"]{ background:#fff1f2; } .chip.on[data-emoji="ğŸ˜®â€ğŸ’¨"]{ background:#ffe4e6; }
    .chip[data-emoji="ğŸ’ª"]{ background:#fefce8; } .chip.on[data-emoji="ğŸ’ª"]{ background:#fef9c3; }

    .stats{ display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
    @media (max-width: 420px){ .stats{ grid-template-columns:1fr; } }

    .stat{
      border:1px solid rgba(224,242,254,.9);
      border-radius:16px;
      padding:10px;
      background:linear-gradient(180deg, #f8fafc, #ffffff);
      box-shadow: var(--shadow);
    }
    .stat .k{ font-size:12px; color:var(--muted); }
    .stat .v{ font-size:18px; font-weight:900; margin-top:2px; }

    .streak{
      font-size:22px;
      background:linear-gradient(90deg, var(--amber), var(--red));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      display:inline-block;
      letter-spacing:1px;
    }

    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    @media (max-width: 520px){ .two{ grid-template-columns:1fr; } }
  </style>
</head>

<body>
<header>
  <h1>âœ… Emoji Quit Tracker</h1>
  <div class="row">
    <button id="prevBtn">â†</button>
    <span class="pill" id="monthPill">Month</span>
    <button id="nextBtn">â†’</button>
    <button id="todayBtn" class="primary">Today</button>
    <button id="exportBtn">Export</button>
    <button id="resetBtn">Reset</button>
  </div>
</header>

<main>
  <div id="reminderBanner" class="banner" style="display:none;"></div>

  <div class="grid">
    <!-- Calendar -->
    <div class="card">
      <div class="calHead">
        <div>
          <div class="monthTitle" id="monthTitle">â€”</div>
          <div class="muted" id="selectedTitle">Select a day</div>
          <div class="muted" id="whyPreview" style="margin-top:6px;"></div>
        </div>

        <div class="controls">
          <select id="viewSelect">
            <option value="month">Month</option>
            <option value="year">Year totals</option>
          </select>

          <select id="focusSelect" title="Focus emoji"></select>

          <label class="pill" style="display:flex; gap:8px; align-items:center;">
            <input id="labelsToggle" type="checkbox" style="transform:scale(1.1);" />
            Labels
          </label>
        </div>
      </div>

      <div id="calendarWrap">
        <div class="cal" id="calDows"></div>
        <div class="cal" id="calendar"></div>
      </div>

      <div id="yearWrap" style="display:none; margin-top:10px;">
        <div class="muted">Year totals (how many days each emoji was used):</div>
        <div style="margin-top:10px;" id="yearTotals"></div>
      </div>
    </div>

    <!-- Day + stats -->
    <div class="card">
      <h2>Tap emojis for this day</h2>
      <div class="muted" style="margin-bottom:10px;">
        No â€œmissed daysâ€, no labels. Just pick what fits today. ğŸŒ±
      </div>

      <div class="emojis" id="emojiList"></div>

      <div style="margin-top:12px;" class="card">
        <h2 style="margin:0 0 8px;">ğŸ“ Notes (optional)</h2>
        <div class="muted" style="margin-bottom:8px;">Keep it as emojis or add words if you want.</div>
        <textarea id="notesBox" placeholder="e.g., ğŸ˜®â€ğŸ’¨ ğŸ§  ğŸ’ª or a short noteâ€¦"></textarea>
        <div class="row" style="margin-top:8px;">
          <button id="saveNotesBtn" class="primary">Save</button>
          <button id="clearNotesBtn">Clear</button>
        </div>
      </div>

      <div style="margin-top:12px;" class="card">
        <h2 style="margin:0 0 8px;">Stats (focus emoji)</h2>
        <div class="muted" style="margin-bottom:10px;">
          Focus shows streak ğŸ”¥, gap days ğŸ•³ï¸, total âœ…, and saved ğŸ’· (if set).
        </div>

        <div class="stats">
          <div class="stat">
            <div class="k">ğŸ”¥ Streak</div>
            <div class="v" id="streakVal">0</div>
          </div>
          <div class="stat">
            <div class="k">ğŸ•³ï¸ Gap days</div>
            <div class="v" id="gapVal">0</div>
          </div>
          <div class="stat">
            <div class="k">âœ… Total days</div>
            <div class="v" id="totalVal">0</div>
          </div>
          <div class="stat">
            <div class="k">ğŸ’· Saved</div>
            <div class="v" id="savedVal">Â£0</div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;" class="card">
        <h2 style="margin:0 0 8px;">Motivation & gentle reminder</h2>

        <div class="two">
          <div>
            <div class="muted" style="margin-bottom:6px;">â¤ï¸ Your â€œwhyâ€ (emoji or words)</div>
            <textarea id="globalWhy" placeholder="e.g., â¤ï¸ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ğŸŒ± ğŸ’· or a sentenceâ€¦"></textarea>
            <button id="saveWhyBtn" class="primary" style="margin-top:8px;">Save</button>
          </div>

          <div>
            <div class="muted" style="margin-bottom:6px;">â° Reminder time (in-app banner)</div>
            <input id="reminderTime" type="time" />
            <div class="muted" style="margin-top:6px;">
              Shows a gentle banner when you open the app after this time and havenâ€™t logged today.
            </div>
            <button id="saveReminderBtn" class="primary" style="margin-top:8px;">Save</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;" />

        <h2 style="margin:0 0 8px;">Exercise emoji</h2>
        <div class="muted" style="margin-bottom:10px;">Pick what â€œexerciseâ€ looks like for you. (Your past logs stay consistent.)</div>

        <div class="two">
          <div>
            <div class="muted" style="margin-bottom:6px;">ğŸƒ Choose exercise emoji</div>
            <select id="exerciseSelect"></select>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px;">ğŸ·ï¸ Exercise label (optional)</div>
            <input id="exerciseLabel" type="text" placeholder="e.g., Walk / Gym / Run" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <button id="saveExerciseBtn" class="primary">Save</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;" />

        <h2 style="margin:0 0 8px;">Focus emoji settings</h2>
        <div class="muted" style="margin-bottom:10px;">Set Â£ saved per day and an optional private label.</div>

        <div class="two">
          <div>
            <div class="muted" style="margin-bottom:6px;">ğŸ’· Â£ saved per day</div>
            <input id="dailySave" type="number" min="0" step="0.5" placeholder="e.g., 10" />
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px;">ğŸ·ï¸ Label (optional)</div>
            <input id="emojiLabel" type="text" placeholder="e.g., Smoke-free / Drink-free" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <button id="saveEmojiSettingsBtn" class="primary">Save</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;" />

        <h2 style="margin:0 0 8px;">Add a custom emoji</h2>
        <div class="muted" style="margin-bottom:8px;">Paste an emoji (or short combo) + optional label.</div>

        <div class="two">
          <input id="customEmoji" type="text" placeholder="e.g., ğŸ§˜" />
          <input id="customEmojiLabel" type="text" placeholder="Optional label" />
        </div>
        <div class="row" style="margin-top:8px;">
          <button id="addCustomBtn" class="primary">Add</button>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  const STORAGE_KEY = "emoji_quit_tracker_v2";

  // Exercise options (user picks one)
  const EXERCISE_OPTIONS = [
    { e:"ğŸ‹ï¸â€â™‚ï¸", l:"Exercise" },
    { e:"ğŸƒ", l:"Run" },
    { e:"ğŸš¶", l:"Walk" },
    { e:"ğŸš´", l:"Cycle" },
    { e:"ğŸ§˜", l:"Stretch" },
    { e:"ğŸŠ", l:"Swim" }
  ];

  // Core defaults (user asked for smoking/gambling/drinking + exercise)
  function buildDefaultEmojis(exerciseEmoji){
    const ex = exerciseEmoji || "ğŸ‹ï¸â€â™‚ï¸";
    return [
      { e:"ğŸ°", l:"Gambling-free" },
      { e:"ğŸš­", l:"Smoke-free" },
      { e:"ğŸºğŸš«", l:"Drink-free" },
      { e: ex,  l:"Exercise done" },

      // gentle support emojis
      { e:"ğŸ”¥", l:"Proud day" },
      { e:"ğŸ’ª", l:"Strong effort" },
      { e:"ğŸ˜Œ", l:"Calm day" },
      { e:"ğŸ§ ", l:"Urges managed" },
      { e:"ğŸ˜®â€ğŸ’¨", l:"Stressy day" },
      { e:"ğŸŒ±", l:"Fresh start" }
    ];
  }

  const DOW = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  function isoDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function parseIso(s){
    const [y,m,d] = s.split("-").map(Number);
    return new Date(y, m-1, d);
  }
  function formatMoneyGBP(n){
    const v = Math.round((Number(n)||0)*100)/100;
    return "Â£" + v.toLocaleString(undefined, { minimumFractionDigits: v%1?2:0, maximumFractionDigits:2 });
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  function loadState(){
    const now = new Date();
    const blank = {
      emojis: buildDefaultEmojis("ğŸ‹ï¸â€â™‚ï¸"),
      marks: {}, notes: {},
      selected: isoDate(now),
      monthAnchor: isoDate(now),
      view: "month",
      focus: "ğŸ°",
      labelsOn: false,
      settings: {
        globalWhy: "",
        reminderTime: "20:00",
        perEmoji: {},
        exerciseEmoji: "ğŸ‹ï¸â€â™‚ï¸",
        exerciseLabel: "Exercise done",
        exercisePrevEmoji: "ğŸ‹ï¸â€â™‚ï¸"
      }
    };

    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return blank;

      const st = JSON.parse(raw);
      st.marks = st.marks || {};
      st.notes = st.notes || {};
      st.selected = st.selected || isoDate(now);
      st.monthAnchor = st.monthAnchor || isoDate(now);
      st.view = st.view || "month";
      st.labelsOn = !!st.labelsOn;
      st.settings = st.settings || {};
      st.settings.perEmoji = st.settings.perEmoji || {};
      st.settings.reminderTime = st.settings.reminderTime || "20:00";
      st.settings.exerciseEmoji = st.settings.exerciseEmoji || "ğŸ‹ï¸â€â™‚ï¸";
      st.settings.exerciseLabel = (st.settings.exerciseLabel ?? "Exercise done");
      st.settings.exercisePrevEmoji = st.settings.exercisePrevEmoji || st.settings.exerciseEmoji;

      // If emojis missing, rebuild with stored exercise emoji
      if(!Array.isArray(st.emojis) || !st.emojis.length){
        st.emojis = buildDefaultEmojis(st.settings.exerciseEmoji);
      }

      // Ensure exercise emoji exists in list
      if(!st.emojis.some(x => x.e === st.settings.exerciseEmoji)){
        // remove any existing exercise option emojis and add chosen one near top
        const exerciseSet = new Set(EXERCISE_OPTIONS.map(x=>x.e));
        st.emojis = st.emojis.filter(x => !exerciseSet.has(x.e));
        st.emojis.splice(3, 0, { e: st.settings.exerciseEmoji, l: "Exercise done" });
      }

      // Ensure focus exists
      if(!st.emojis.some(x=>x.e === st.focus)) st.focus = st.emojis[0].e;

      return st;
    }catch{
      return blank;
    }
  }

  function saveState(st){ localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }

  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function calendarCells(anchorDate){
    const first = startOfMonth(anchorDate);
    const firstDow = (first.getDay() + 6) % 7; // Mon=0..Sun=6
    const cells = [];
    const start = new Date(first);
    start.setDate(first.getDate() - firstDow);
    for(let i=0;i<42;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      cells.push({ date:d, iso:isoDate(d), inMonth: d.getMonth() === anchorDate.getMonth() });
    }
    return { cells };
  }
  function monthLabel(d){
    return d.toLocaleString(undefined, { month:"long", year:"numeric" });
  }

  function getMarksForDay(st, iso){
    return Array.isArray(st.marks[iso]) ? st.marks[iso] : [];
  }
  function toggleMark(st, iso, emoji){
    const set = new Set(getMarksForDay(st, iso));
    if(set.has(emoji)) set.delete(emoji);
    else set.add(emoji);
    st.marks[iso] = Array.from(set);
  }
  function dayHasEmoji(st, iso, emoji){
    return getMarksForDay(st, iso).includes(emoji);
  }

  function completedDays(st, emoji){
    const days = [];
    for(const [day, arr] of Object.entries(st.marks)){
      if(Array.isArray(arr) && arr.includes(emoji)) days.push(day);
    }
    return days.sort();
  }

  function streakFor(st, emoji){
    const today = isoDate(new Date());
    if(!dayHasEmoji(st, today, emoji)) return 0;
    let streak = 0;
    let d = parseIso(today);
    while(true){
      const key = isoDate(d);
      if(dayHasEmoji(st, key, emoji)){
        streak++;
        d.setDate(d.getDate()-1);
      } else break;
    }
    return streak;
  }

  function gapSinceLast(st, emoji){
    const today = isoDate(new Date());
    const days = completedDays(st, emoji);
    if(days.length === 0) return 0;
    const last = days[days.length-1];
    if(last === today) return 0;
    const diff = Math.floor((parseIso(today) - parseIso(last)) / (24*3600*1000)) - 1;
    return Math.max(0, diff);
  }

  function totalCompleted(st, emoji){ return completedDays(st, emoji).length; }

  function moneySaved(st, emoji){
    const per = st.settings.perEmoji[emoji] || {};
    const daily = Number(per.dailySave) || 0;
    return daily * totalCompleted(st, emoji);
  }

  function yearTotals(st, year){
    const totals = {};
    st.emojis.forEach(x => totals[x.e]=0);
    for(const [day, arr] of Object.entries(st.marks)){
      if(!arr || !arr.length) continue;
      if(day.startsWith(String(year) + "-")){
        arr.forEach(e => { if(totals[e] !== undefined) totals[e]++; });
      }
    }
    return totals;
  }

  function shouldShowReminderBanner(st){
    const t = st.settings.reminderTime;
    if(!t) return false;
    const [hh, mm] = t.split(":").map(Number);
    if(Number.isNaN(hh) || Number.isNaN(mm)) return false;

    const now = new Date();
    const minsNow = now.getHours()*60 + now.getMinutes();
    const minsSet = hh*60 + mm;

    const today = isoDate(now);
    const any = getMarksForDay(st, today).length > 0;
    return minsNow >= minsSet && !any;
  }

  function focusLabel(st){
    const found = st.emojis.find(x => x.e === st.focus);
    const per = st.settings.perEmoji[st.focus] || {};
    // allow custom label, else default label, else blank
    const fallback = (found && found.l) || "";
    return (per.label || fallback || "").trim();
  }

  // Migration: if exercise emoji changes, swap old->new in all marks + settings
  function migrateExerciseEmoji(st, oldEmoji, newEmoji){
    if(!oldEmoji || !newEmoji || oldEmoji === newEmoji) return;

    for(const day of Object.keys(st.marks)){
      const arr = getMarksForDay(st, day);
      if(!arr.length) continue;
      const out = arr.map(e => e === oldEmoji ? newEmoji : e);
      // de-dupe
      st.marks[day] = Array.from(new Set(out));
    }

    // move perEmoji settings if user had dailySave etc on old exercise emoji
    if(st.settings.perEmoji[oldEmoji] && !st.settings.perEmoji[newEmoji]){
      st.settings.perEmoji[newEmoji] = st.settings.perEmoji[oldEmoji];
      delete st.settings.perEmoji[oldEmoji];
    }
  }

  function render(){
    const st = loadState();
    const selectedIso = st.selected;
    const selectedDate = parseIso(selectedIso);
    const anchorDate = parseIso(st.monthAnchor);

    // reminder banner
    const banner = document.getElementById("reminderBanner");
    if(shouldShowReminderBanner(st)){
      const why = (st.settings.globalWhy || "").trim();
      banner.style.display = "block";
      banner.innerHTML = `<b>Gentle nudge:</b> log your day âœ¨${why ? `<br><span class="muted">â¤ï¸ ${escapeHtml(why)}</span>` : ""}`;
    } else {
      banner.style.display = "none";
      banner.innerHTML = "";
    }

    // month labels
    document.getElementById("monthPill").textContent = monthLabel(anchorDate);
    document.getElementById("monthTitle").textContent = monthLabel(anchorDate);

    // view
    const viewSelect = document.getElementById("viewSelect");
    viewSelect.value = st.view || "month";
    const isYear = viewSelect.value === "year";
    document.getElementById("calendarWrap").style.display = isYear ? "none" : "block";
    document.getElementById("yearWrap").style.display = isYear ? "block" : "none";

    // labels toggle
    const labelsToggle = document.getElementById("labelsToggle");
    labelsToggle.checked = !!st.labelsOn;

    // focus select
    const focusSelect = document.getElementById("focusSelect");
    focusSelect.innerHTML = "";
    st.emojis.forEach(x=>{
      const opt = document.createElement("option");
      opt.value = x.e;
      opt.textContent = st.labelsOn ? `${x.e}  ${x.l || ""}` : x.e;
      focusSelect.appendChild(opt);
    });
    if(!st.emojis.some(x=>x.e === st.focus)) st.focus = st.emojis[0].e;
    focusSelect.value = st.focus;

    // selected title
    const niceSel = selectedDate.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
    document.getElementById("selectedTitle").textContent = `Selected: ${niceSel}`;

    // why preview
    const globalWhy = (st.settings.globalWhy || "").trim();
    const fl = focusLabel(st);
    document.getElementById("whyPreview").innerHTML = globalWhy
      ? `â¤ï¸ ${escapeHtml(globalWhy)}`
      : (fl ? `ğŸ·ï¸ ${escapeHtml(fl)}` : "");

    // exercise select
    const exSel = document.getElementById("exerciseSelect");
    exSel.innerHTML = "";
    EXERCISE_OPTIONS.forEach(x=>{
      const opt = document.createElement("option");
      opt.value = x.e;
      opt.textContent = `${x.e}  ${x.l}`;
      exSel.appendChild(opt);
    });
    exSel.value = st.settings.exerciseEmoji || "ğŸ‹ï¸â€â™‚ï¸";
    document.getElementById("exerciseLabel").value = st.settings.exerciseLabel ?? "";

    // DOW
    const dows = document.getElementById("calDows");
    dows.innerHTML = "";
    DOW.forEach(x=>{
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = x;
      dows.appendChild(el);
    });

    // calendar
    const cal = document.getElementById("calendar");
    cal.innerHTML = "";
    const { cells } = calendarCells(anchorDate);

    cells.forEach(c=>{
      const marks = getMarksForDay(st,c.iso);

      const dayEl = document.createElement("div");
      dayEl.className =
        "day" +
        (c.inMonth ? "" : " other") +
        (c.iso === selectedIso ? " selected" : "") +
        (marks.length ? " has-emoji" : "");

      dayEl.addEventListener("click", ()=>{
        const s = loadState();
        s.selected = c.iso;
        saveState(s);
        render();
      });

      const top = document.createElement("div");
      top.className = "num";
      top.innerHTML = `<span>${c.date.getDate()}</span><span>${marks.length ? "âœ¨" : ""}</span>`;

      const emojis = document.createElement("div");
      emojis.className = "emojis";

      marks.slice(0,6).forEach(e=>{
        const b = document.createElement("div");
        b.className = "pill";
        b.style.color = "var(--text)";
        b.style.fontSize = "14px";
        b.textContent = e;
        emojis.appendChild(b);
      });
      if(marks.length > 6){
        const more = document.createElement("div");
        more.className = "pill";
        more.textContent = `+${marks.length - 6}`;
        emojis.appendChild(more);
      }

      dayEl.appendChild(top);
      dayEl.appendChild(emojis);
      cal.appendChild(dayEl);
    });

    // emoji list for selected day
    const list = document.getElementById("emojiList");
    list.innerHTML = "";
    const selectedMarks = new Set(getMarksForDay(st, selectedIso));

    st.emojis.forEach(x=>{
      const btn = document.createElement("button");
      btn.className = "chip" + (selectedMarks.has(x.e) ? " on" : "");
      btn.type = "button";
      btn.setAttribute("data-emoji", x.e);

      const label = (st.settings.perEmoji[x.e]||{}).label || x.l || "";
      btn.innerHTML = st.labelsOn && label
        ? `${escapeHtml(x.e)} <span class="label">${escapeHtml(label)}</span>`
        : `${escapeHtml(x.e)}`;

      btn.addEventListener("click", ()=>{
        const s = loadState();
        toggleMark(s, selectedIso, x.e);
        saveState(s);
        render();
      });

      list.appendChild(btn);
    });

    // notes
    document.getElementById("notesBox").value = st.notes[selectedIso] || "";

    // settings fill
    document.getElementById("globalWhy").value = st.settings.globalWhy || "";
    document.getElementById("reminderTime").value = st.settings.reminderTime || "20:00";

    // per-emoji settings for focus
    const per = st.settings.perEmoji[st.focus] || {};
    document.getElementById("dailySave").value = (per.dailySave ?? "");
    document.getElementById("emojiLabel").value = (per.label ?? focusLabel(st));

    // stats
    const streak = streakFor(st, st.focus);
    document.getElementById("streakVal").innerHTML = streak ? `<span class="streak">${"ğŸ”¥".repeat(Math.min(20, streak))}</span>` : "0";
    document.getElementById("gapVal").textContent = String(gapSinceLast(st, st.focus));
    document.getElementById("totalVal").textContent = String(totalCompleted(st, st.focus));
    document.getElementById("savedVal").textContent = formatMoneyGBP(moneySaved(st, st.focus));

    // year totals
    if(isYear){
      const yr = anchorDate.getFullYear();
      const totals = yearTotals(st, yr);
      const wrap = document.getElementById("yearTotals");
      wrap.innerHTML = "";
      const entries = Object.entries(totals).sort((a,b)=> b[1]-a[1]);
      entries.forEach(([e,v])=>{
        const row = document.createElement("div");
        row.className = "stat";
        row.style.marginBottom = "8px";
        const label = (st.settings.perEmoji[e]||{}).label || (st.emojis.find(x=>x.e===e)||{}).l || "";
        row.innerHTML = `<div class="k">${escapeHtml(e)} ${st.labelsOn && label ? " â€” " + escapeHtml(label) : ""}</div><div class="v">${v}</div>`;
        wrap.appendChild(row);
      });
    }
  }

  // Navigation / UI handlers
  document.getElementById("prevBtn").addEventListener("click", ()=>{
    const st = loadState();
    const d = parseIso(st.monthAnchor);
    d.setMonth(d.getMonth()-1);
    st.monthAnchor = isoDate(d);
    saveState(st);
    render();
  });

  document.getElementById("nextBtn").addEventListener("click", ()=>{
    const st = loadState();
    const d = parseIso(st.monthAnchor);
    d.setMonth(d.getMonth()+1);
    st.monthAnchor = isoDate(d);
    saveState(st);
    render();
  });

  document.getElementById("todayBtn").addEventListener("click", ()=>{
    const st = loadState();
    const t = new Date();
    st.selected = isoDate(t);
    st.monthAnchor = isoDate(t);
    saveState(st);
    render();
  });

  document.getElementById("viewSelect").addEventListener("change", (e)=>{
    const st = loadState();
    st.view = e.target.value;
    saveState(st);
    render();
  });

  document.getElementById("focusSelect").addEventListener("change", (e)=>{
    const st = loadState();
    st.focus = e.target.value;
    saveState(st);
    render();
  });

  document.getElementById("labelsToggle").addEventListener("change", (e)=>{
    const st = loadState();
    st.labelsOn = !!e.target.checked;
    saveState(st);
    render();
  });

  // Notes
  document.getElementById("saveNotesBtn").addEventListener("click", ()=>{
    const st = loadState();
    st.notes[st.selected] = document.getElementById("notesBox").value || "";
    saveState(st);
    alert("Saved âœ…");
    render();
  });

  document.getElementById("clearNotesBtn").addEventListener("click", ()=>{
    const st = loadState();
    if(!confirm("Clear notes for this day?")) return;
    delete st.notes[st.selected];
    saveState(st);
    render();
  });

  // Why + reminder
  document.getElementById("saveWhyBtn").addEventListener("click", ()=>{
    const st = loadState();
    st.settings.globalWhy = document.getElementById("globalWhy").value || "";
    saveState(st);
    alert("Saved â¤ï¸");
    render();
  });

  document.getElementById("saveReminderBtn").addEventListener("click", ()=>{
    const st = loadState();
    st.settings.reminderTime = document.getElementById("reminderTime").value || "20:00";
    saveState(st);
    alert("Saved â°");
    render();
  });

  // Exercise settings + migration
  document.getElementById("saveExerciseBtn").addEventListener("click", ()=>{
    const st = loadState();
    const newEmoji = document.getElementById("exerciseSelect").value;
    const newLabel = document.getElementById("exerciseLabel").value || "Exercise done";

    const oldEmoji = st.settings.exerciseEmoji || "ğŸ‹ï¸â€â™‚ï¸";
    st.settings.exercisePrevEmoji = oldEmoji;
    st.settings.exerciseEmoji = newEmoji;
    st.settings.exerciseLabel = newLabel;

    // migrate existing logs from old exercise emoji to new
    migrateExerciseEmoji(st, oldEmoji, newEmoji);

    // rebuild emoji list: remove any exercise emojis, insert chosen one into slot 4
    const exerciseSet = new Set(EXERCISE_OPTIONS.map(x=>x.e));
    st.emojis = st.emojis.filter(x => !exerciseSet.has(x.e));
    st.emojis.splice(3, 0, { e:newEmoji, l:"Exercise done" });

    // also update label for the chosen emoji
    st.settings.perEmoji[newEmoji] = st.settings.perEmoji[newEmoji] || {};
    st.settings.perEmoji[newEmoji].label = newLabel;

    saveState(st);
    alert("Saved ğŸƒ");
    render();
  });

  // Per-emoji settings for focus
  document.getElementById("saveEmojiSettingsBtn").addEventListener("click", ()=>{
    const st = loadState();
    const e = st.focus;
    st.settings.perEmoji[e] = st.settings.perEmoji[e] || {};
    st.settings.perEmoji[e].dailySave = Number(document.getElementById("dailySave").value || 0);
    st.settings.perEmoji[e].label = document.getElementById("emojiLabel").value || "";
    saveState(st);
    alert("Saved âœ¨");
    render();
  });

  // Add custom emoji
  document.getElementById("addCustomBtn").addEventListener("click", ()=>{
    const emoji = (document.getElementById("customEmoji").value || "").trim();
    const label = (document.getElementById("customEmojiLabel").value || "").trim();
    if(!emoji) return;

    const st = loadState();
    if(!st.emojis.some(x=>x.e === emoji)){
      st.emojis.push({ e: emoji, l: label });
      saveState(st);
    }
    document.getElementById("customEmoji").value = "";
    document.getElementById("customEmojiLabel").value = "";
    render();
  });

  // Export / reset
  document.getElementById("exportBtn").addEventListener("click", async ()=>{
    const st = loadState();
    const blob = new Blob([JSON.stringify(st, null, 2)], { type:"application/json" });
    const file = new File([blob], "emoji-quit-tracker-export.json", { type:"application/json" });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({ files: [file], title: "Emoji Quit Tracker Export" });
    } else {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "emoji-quit-tracker-export.json";
      a.click();
      URL.revokeObjectURL(url);
      alert("Exported. If it didnâ€™t download, open from Safari and try again.");
    }
  });

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    if(!confirm("Reset everything? This clears emojis, notes, and settings.")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  });

  render();
</script>
</body>
</html>